#
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀  ⠀⣴⣶⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀          ⢰⣶⣿⣿⣿⣿⣿⡆
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀ ⢰⣿⡏⠀⠀⠀⢸⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀       ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⢰⣿⡏⠀⠀⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⠀⠀⠀⣴⣿⣿⣿⣿⣿⣷⣤⣤⣤⣄⠀⣾⣿⠁⠀⠀⠀⣿⣿⣤⣤⣀⠀⠀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣤⣤⣤⣄⠀⠀⣠⣴⣶⣶⣶⣶⣦⡀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣤⣤⣄⣀⣿⡿⠀⠀⠀⢰⣿⡏⠀⢀⣀⣤⣤⣤⣤⣀
# ⠀     ⠀⠀⠀⠀⠀⢸⣿⡏⠀⠀⠀⠸⠟⠛⠛⠛⢿⣿⣿⡿⠀⠀⠀⢸⠿⠛⠛⠻⢿⣿⣄⠀⣴⣾⡿⠟⠛⠛⠛⠿⠛⠛⠛⢻⣿⡇⣸⣿⠟⠉⠉⠉⢹⣿⡇⣾⡿⠟⠛⠛⠛⠿⠛⠛⠛⢻⣿⣿⡏⠀⠀ ⣼⣿⣡⣶⣿⠿⠟⠛⠛⠻⢿⣿⣆
# ⠀     ⠀⠀⠀⠀⠀⣾⣿⠁⠀⠀⠀⣠⣤⡄⠀⠀⠀⢿⣿⠇⠀⠀⠀⢀⣀⡀⠀⠀⠀⢿⣿⣾⣿⠋⠀⠀⢀⣴⣶⡄⠀⠀⠀⣼⣿⢣⣿⡿⠀⠀⠀⠀⢸⣿⣷⣿⡿⠃⠀⠀⢠⣤⣤⠀⠀⠀⠀⣿⣿⣿⡏⠀⠀  ⣿⣿⣿⠟⠁⠀⠀⣤⣶⡄⠀⢻⣿⡄
# ⠀     ⠀⠀⠀⠀⢠⣿⡟⠀⠀⠀⢰⣿⣿⣿⠀⠀⠀⢸⣿⠀⠀⠀⢠⣾⣿⡇⠀⠀⠀⣾⣿⡿⠁⠀⠀⢠⣿⣿⣿⠁⠀⠀⠀⣿⣿⣿⣿⠁⣼⠀⠀⠀⠸⣿⣿⡟⠀⠀⠀⣰⣿⣿⡟⠀⠀⠀⢸⣿⣿⡏⠀⠀⠀⣼⣿⣿⠋⠀⠀⠀⣼⣿⣿⡇⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⠀⣸⣿⠇⠀⠀⠀⣾⣿⣿⡏⠀⠀⠀⣼⡇⠀⠀⠀⣸⣿⣿⠁⠀⠀⢠⣿⣿⠇⠀⠀⠀⣾⣿⣿⡟⠀⠀⠀⢸⣿⣿⣿⠃⣰⣿⠀⠀⠀⠀⣿⡿⠀⠀⠀⢠⣿⣿⣿⠇⠀⠀⠀⣾⣿⣿⠁⠀⠀⠀⣿⣿⡏⠀⠀⠀⢸⣿⣿⣿⠃⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⢀⣿⣿⠀⠀⠀⢠⣿⣿⣿⠁⠀⠀⢀⣿⠀⠀⠀⢀⣿⣿⡏⠀⠀⠀⣸⣿⣿⠀⠀⠀⢰⣿⣿⣿⠃⠀⠀⠀⣿⣿⡟⠃⠀⣿⣿⠀⠀⠀⠀⣿⡇⠀⠀⠀⢸⣿⣿⡿⠀⠀⠀⢠⣿⣿⡟⠀⠀⠀⢸⣿⣿⠁⠀⠀⠀⣿⣿⣿⡟⠀⠀⣾⣿⠁
# ⠀     ⠀⠀⠀⢸⣿⡇⠀⠀⠀⢼⣿⡿⠃⠀⠀⢀⣼⡟⠀⠀⠀⢸⣿⣿⡇⠀⠀⠀⢿⣿⠏⠀⠀⠀⠘⢿⡿⠏⠀⠀⠀⠀⣿⡿⠀⢠⣤⣿⡿⠀⠀⠀⠀⠋⡀⠀⠀⠀⠸⣿⡿⠃⠀⠀⠀⢸⣿⡿⠁⠀⠀⠀⢿⣿⠟⠀⠀⠀⠀⢿⣿⡟⠁⠀⣼⣿⡏
# ⠀     ⠀⠀⠀⣾⣿⠁⠀⠀⠀⠀⠀⠀⠀⢀⣠⣾⣿⠃⠀⠀⠀⣿⣿⣿⣧⠀⠀⠀⠀⠀⣠⣆⠀⠀⠀⠀⢀⣴⣆⠀⠀⠀⠀⣀⣤⠀⠉⠉⠀⠀⠀⣠⣴⣿⣷⡀⠀⠀⠀⠀⢀⣴⡀⠀⠀⠀⠀⣠⣆⠀⠀⠀⠀⠀⣠⣦⡀⠀⠀⠀  ⠀⠀⣠⣾⣿⠏
# ⠀     ⠀⠀⢰⣿⡏⠀⠀⠀⢸⣿⣶⣶⣿⣿⡿⢿⣿⣷⣶⣶⣾⣿⠏⠙⢿⣿⣶⣶⣾⣿⡿⢿⣿⣶⣶⣾⣿⡿⣿⣷⣶⣶⣿⣿⢿⣿⣶⣶⣶⣾⣿⡿⠟⠉⠻⣿⣷⣶⣶⣾⣿⢿⣿⣶⣶⣶⣿⡿⣿⣷⣶⣶⣶⣿⡿⡿⠟
# ⠀     ⠀⠀⣼⣿⠃⠀⠀⠀⣿⣿⠉
# ⠀     ⠀⢰⣿⡿⠀⠀⠀⢰⣿⡏
# ⠀     ⠀⣾⣿⣷⣶⣶⣿⣿⠿⠁⠀⠀⠀⠀⠀⢀⣶⠿⢿⣶⢀⣶⡆⢀⣶⠆⢠⣾⣿⠀⢀⣴⣶⠿⠇⠀⣾⢿⡇⠀⣴⡿⠀⢀⣴⣶⣷⣶⡄⢀⣾⠿⢿⣦⢀⣶⡾⠿⠇⣾⡿⢿⣶⠀⣴⣶⠀⣴⣿⣷⠀⠀⠀⢠⣾⠿⣿⣦⢀⣶⠆⢰⣿⠂
#                 ⠀⠀⠀⠀⠀⠀⣼⣿⣤⣾⠟⣸⣿⣶⣾⡟⢠⣿⣃⣿⡇⠘⢿⣧⡀⠀⣼⣏⣸⡇⢠⣿⠃⠀⣾⡟⠁⠈⣿⠇⣼⣿⣤⣾⠏⣸⡿⠶⠆⢸⣿⠁⣸⣿⢠⣿⠇⣸⣟⣸⣿⠀⠀⠀⣾⣿⣤⡿⠋⣼⡟⠀⣾⡏
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠋⠉⠀⠀⣿⠇⠠⠿⠃⠿⠛⠻⣿⠡⣶⣶⠿⠟⠼⠟⠛⣿⡇⣾⣿⡶⠆⠻⢿⣶⠾⠋⢠⣿⠋⠉⠀⠠⠿⠷⠶⠀⢿⣷⠾⠟⠁⣼⡟⠰⠿⠛⢻⡿⠠⡶⢰⡿⠉⢿⠇⠀⢿⣷⣾⠟⠁
#

import logging
import asyncio
from aiogram import Dispatcher

from config import bot, scheduler
from bot.middlewares.get_user import GetUserMiddleware
from bot.middlewares.shadow_ban import ShadowBanMiddleware
from bot.middlewares.logging_query import UserLoggerMiddleware
from bot.scheduler import load_scheduled_notifications

from bot import handlers
from DB import init_database
from utils.db_manager import backup_db

logger = logging.getLogger(__name__)


async def main() -> None:
    logger.info('Creating db tables')
    init_database()

    dp = Dispatcher()

    logger.info('Including routers')
    dp.include_router(handlers.admin.router)
    dp.include_router(handlers.commands.router)
    dp.include_router(handlers.master.router)
    dp.include_router(handlers.default.router)
    dp.include_router(handlers.callbacks.admin.router)
    dp.include_router(handlers.callbacks.master.router)
    dp.include_router(handlers.callbacks.appointment_pages.router)
    dp.include_router(handlers.callbacks.user_navigation.router)

    logger.info('Including middlewares')
    dp.update.middleware(GetUserMiddleware())
    dp.update.middleware(ShadowBanMiddleware())
    dp.message.middleware.register(UserLoggerMiddleware())
    dp.inline_query.middleware.register(UserLoggerMiddleware())

    logger.info(f'{(await bot.get_me()).first_name} starting\n * Running on http://t.me/{(await bot.get_me()).username}')

    scheduler.add_job(backup_db, 'cron', hour=5, minute=0, args=(bot,))
    load_scheduled_notifications()
    scheduler.start()
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.exception(e)


if __name__ == '__main__':
    asyncio.run(main())
